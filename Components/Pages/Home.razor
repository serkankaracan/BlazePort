@page "/"
@rendermode InteractiveServer

@using BlazePort.Models
@using BlazePort.Services
@using BlazePort.Data
@using BlazePort.Runtime
@inject PortScanner Scanner
@inject SqlitePortProvider PortProvider
@inject AppArgs AppArgs
@inject IJSRuntime JS

<PageTitle>BlazePort</PageTitle>

<div class="container" style="max-width:1100px;">
    <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
        <h3 class="mb-0">BlazePort</h3>
        <span class="badge @GetModeBadgeClass()" style="font-size:0.95rem;">
            Mode: @AppArgs.Mode
        </span>
    </div>

    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <b>Error:</b> @ErrorMessage
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6">
                    <label class="form-label"><b>Target Host / IP</b></label>
                    <input class="form-control" @bind="TargetHost" placeholder="e.g. 10.0.0.10 or server.local" />
                </div>
                <div class="col-12 col-md-6 d-flex gap-2">
                    <button class="btn btn-primary" @onclick="RunAsync" disabled="@IsRunning">
                        @(IsRunning ? "Running..." : "Run")
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">Ports loaded: <b>@Ports.Count</b></small>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header py-2 user-select-none @(CustomPortExpanded ? "" : "border-0")" style="cursor: pointer;"
             @onclick="ToggleCustomPortSection"
             @onkeydown="OnCustomPortHeaderKeydown"
             role="button"
             tabindex="0">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Custom Port</h5>
                <span class="badge bg-light text-dark">@(CustomPortExpanded ? "▼" : "▶")</span>
            </div>
        </div>
        <div class="collapse @(CustomPortExpanded ? "show" : "")">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-3">
                        <label class="form-label"><b>Port</b></label>
                        <input class="form-control" inputmode="numeric" @bind="CustomPortText" placeholder="554" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label"><b>Name (optional)</b></label>
                        <input class="form-control" @bind="CustomPortName" placeholder="RTSP" />
                    </div>
                    <div class="col-12 col-md-3 d-flex gap-2">
                        <button class="btn btn-success w-100" @onclick="AddCustomPort" disabled="@IsRunning">
                            Add Port
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (Results.Count > 0)
    {
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Results</h5>

                @{
                    var total = Results.Count;
                    var scanned = Results.Count(r => r.Checked);
                    var scannedPct = total == 0 ? 0 : (scanned * 100.0) / total;
                    var inv = System.Globalization.CultureInfo.InvariantCulture;
                }

                <div class="mb-3">
                    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                        <span class="badge bg-success">Open: @Results.Count(r => r.Checked && r.PortStatus == PortStatus.Open)</span>
                        <span class="badge bg-danger">Closed: @Results.Count(r => r.Checked && r.PortStatus != PortStatus.Open)</span>
                        <span class="badge bg-secondary">Not checked: @Results.Count(r => !r.Checked)</span>
                        <span class="text-muted ms-auto">
                            Scanned: <b>@scanned</b> / <b>@total</b>
                        </span>
                    </div>

                    <div class="progress mt-2" style="height: 22px; background-color: #e9ecef;">
                        <div class="progress-bar" role="progressbar" style="width:@scannedPct.ToString("0.###", inv)%; background-color: #0d6efd;"
                             aria-valuenow="@scanned" aria-valuemin="0" aria-valuemax="@total">
                            @scannedPct.ToString("0.#")%
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                @if (IsAdminMode)
                                {
                                    <th>Mode</th>
                                }
                                <th style="width:150px;">Port</th>
                                <th style="width:120px;">Ping</th>
                                <th style="width:110px;">Ping ms</th>
                                <th style="width:150px;">Telnet</th>
                                <th>Details</th>
                                <th style="width:110px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in Results)
                            {
                                <tr>
                                    <td>@r.Name</td>
                                    @if (IsAdminMode)
                                    {
                                        <td>
                                            @foreach (var m in r.Modes.Split(", ", StringSplitOptions.RemoveEmptyEntries))
                                            {
                                                <span class="badge @(m == "Client" ? "bg-primary" : "bg-warning text-dark") me-1">@m</span>
                                            }
                                        </td>
                                    }
                                    <td>@r.Port</td>
                                    <td>@RenderStatusBadge(r.Checked ? r.PingOk : null)</td>
                                    <td>@(r.PingMs?.ToString() ?? "-")</td>
                                    <td>@RenderPortBadge(r)</td>
                                    <td class="text-muted">@GetRowDetails(r)</td>
                                    <td>
                                        @if (CustomPorts.Contains(r.Key))
                                        {
                                            <button class="btn btn-sm btn-outline-danger"
                                                    @onclick="() => RemoveCustomPort(r.Key)"
                                                    disabled="@IsRunning">
                                                Remove
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-outline-dark" @onclick="ExportPdfAsync" disabled="@(!CanExportPdf)">
                        @(IsExporting ? "Exporting..." : "Export PDF")
                    </button>
                </div>
            </div>
        </div>
    }
</div>
