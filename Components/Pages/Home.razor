@page "/"
@rendermode InteractiveServer

@using BlazePort.Models
@using BlazePort.Services
@using BlazePort.Data
@using BlazePort.Runtime
@inject PortScanner Scanner
@inject IPortProvider PortProvider
@inject AppArgs AppArgs

<PageTitle>BlazePort</PageTitle>

<div class="container" style="max-width:1100px;">
    <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
        <h3 class="mb-0">BlazePort</h3>
        <span class="badge @GetModeBadgeClass()" style="font-size:0.95rem;">
            Mode: @AppArgs.Mode
        </span>
    </div>

    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <b>Error:</b> @ErrorMessage
        </div>
    }

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-6">
                    <label class="form-label"><b>Target Host / IP</b></label>
                    <input class="form-control" @bind="TargetHost" placeholder="e.g. 10.0.0.10 or server.local" />
                </div>
                <div class="col-12 col-md-6 d-flex gap-2">
                    <button class="btn btn-primary" @onclick="RunAsync" disabled="@IsRunning">
                        @(IsRunning ? "Running..." : "Run")
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ReloadPorts" disabled="@IsRunning">
                        Reload Ports
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">Ports loaded: <b>@Ports.Count</b></small>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h5 class="mb-3">Custom Port</h5>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-3">
                    <label class="form-label"><b>Port</b></label>
                    <input class="form-control" inputmode="numeric" @bind="CustomPortText" placeholder="554" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label"><b>Name (optional)</b></label>
                    <input class="form-control" @bind="CustomPortName" placeholder="RTSP" />
                </div>
                <div class="col-12 col-md-3 d-flex gap-2">
                    <button class="btn btn-success w-100" @onclick="AddCustomPort" disabled="@IsRunning">
                        Add Port
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (Results.Count > 0)
    {
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Results</h5>

                @{
                    var total = Results.Count;
                    var open = Results.Count(r => r.Checked && r.PortStatus == PortStatus.Open);
                    var closed = Results.Count(r => r.Checked && r.PortStatus != PortStatus.Open);
                    var notChecked = Results.Count(r => !r.Checked);

                    double Pct(int x) => total == 0 ? 0 : (x * 100.0) / total;

                    var openPct = Pct(open);
                    var closedPct = Pct(closed);
                    var notCheckedPct = Pct(notChecked);
                }

                <div class="mb-3">
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="badge bg-success">Open: @open (@openPct.ToString("0.#")%)</span>
                        <span class="badge bg-danger">Closed: @closed (@closedPct.ToString("0.#")%)</span>
                        <span class="badge bg-secondary">Not checked: @notChecked (@notCheckedPct.ToString("0.#")%)</span>
                        <span class="text-muted ms-auto">
                            Checked: <b>@(open + closed)</b> / <b>@total</b>
                        </span>
                    </div>

                    <div class="progress mt-2" style="height: 22px;">
                        @{ var inv = System.Globalization.CultureInfo.InvariantCulture; }

                        <div class="progress-bar bg-success" style="width:@openPct.ToString("0.###", inv)%">
                            @if (openPct >= 10) { <text>@openPct.ToString("0.#")%</text> }
                        </div>
                        <div class="progress-bar bg-danger" style="width:@closedPct.ToString("0.###", inv)%">
                            @if (closedPct >= 10) { <text>@closedPct.ToString("0.#")%</text> }
                        </div>
                        <div class="progress-bar bg-secondary" style="width:@notCheckedPct.ToString("0.###", inv)%">
                            @if (notCheckedPct >= 10) { <text>@notCheckedPct.ToString("0.#")%</text> }
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                @if (IsAdminMode)
                                {
                                    <th>Mode</th>
                                }
                                <th style="width:150px;">Endpoint</th>
                                <th style="width:120px;">Ping</th>
                                <th style="width:110px;">Ping ms</th>
                                <th style="width:150px;">Port</th>
                                <th>Details</th>
                                <th style="width:110px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in Results)
                            {
                                <tr>
                                    <td>@r.Name</td>
                                    @if (IsAdminMode)
                                    {
                                        <td>
                                            @foreach (var m in r.Modes.Split(", ", StringSplitOptions.RemoveEmptyEntries))
                                            {
                                                <span class="badge @(m == "Client" ? "bg-primary" : "bg-warning text-dark") me-1">@m</span>
                                            }
                                        </td>
                                    }
                                    <td>@r.Port</td>
                                    <td>@RenderStatusBadge(r.Checked ? r.PingOk : null)</td>
                                    <td>@(r.PingMs?.ToString() ?? "-")</td>
                                    <td>@RenderPortBadge(r)</td>
                                    <td class="text-muted">@GetRowDetails(r)</td>
                                    <td>
                                        @if (CustomPorts.Contains(r.Key))
                                        {
                                            <button class="btn btn-sm btn-outline-danger"
                                                    @onclick="() => RemoveCustomPort(r.Key)"
                                                    disabled="@IsRunning">
                                                Remove
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool IsAdminMode => AppArgs.Mode == AppMode.Admin;
    private string TargetHost { get; set; } = "localhost";
    private bool IsRunning { get; set; }
    private string? ErrorMessage { get; set; }

    private List<ServiceEndpoint> Ports { get; set; } = new();
    private List<PortRow> Results { get; } = new();

    private string CustomPortText { get; set; } = string.Empty;
    private string CustomPortName { get; set; } = string.Empty;
    private HashSet<string> CustomPorts { get; } = new();

    protected override void OnInitialized()
    {
        LoadPorts();
        RebuildResults();
    }

    private void ReloadPorts()
    {
        try
        {
            ErrorMessage = null;
            LoadPorts();
            RebuildResults();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private void LoadPorts()
    {
        CustomPorts.Clear();
        Ports = PortProvider.GetPorts(AppArgs.Mode).ToList();
    }

    private void RebuildResults()
    {
        Results.Clear();
        foreach (var ep in Ports)
            Results.Add(PortRow.NotChecked(ep.ServiceName, ep.Port, ep.Modes));
    }

    private void AddCustomPort()
    {
        try
        {
            ErrorMessage = null;

            if (!int.TryParse((CustomPortText ?? string.Empty).Trim(), out var port))
            {
                ErrorMessage = "Custom port must be a number.";
                return;
            }

            if (port is < 1 or > 65535)
            {
                ErrorMessage = "Custom port must be between 1 and 65535.";
                return;
            }

            if (Ports.Any(p => p.Port == port))
            {
                ErrorMessage = $"Port {port} is already in the list.";
                return;
            }

            var name = (CustomPortName ?? string.Empty).Trim();
            if (string.IsNullOrWhiteSpace(name))
                name = $"Custom-{port}";

            Ports.Add(new ServiceEndpoint(name, port));
            CustomPorts.Add(PortRow.MakeKey(port));

            RebuildResults();

            CustomPortText = string.Empty;
            CustomPortName = string.Empty;
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private void RemoveCustomPort(string key)
    {
        try
        {
            if (!CustomPorts.Contains(key))
                return;

            var port = PortRow.ParseKey(key);

            Ports.RemoveAll(p => p.Port == port);
            CustomPorts.Remove(key);

            RebuildResults();
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private async Task RunAsync()
    {
        ErrorMessage = null;
        RebuildResults();

        var host = (TargetHost ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(host))
        {
            ErrorMessage = "Target host is required.";
            return;
        }

        if (Ports.Count == 0)
        {
            ErrorMessage = "No ports configured.";
            return;
        }

        IsRunning = true;

        try
        {
            foreach (var ep in Ports)
            {
                var ping = await Scanner.PingAsync(host, timeoutMs: 1000);
                var portResult = await Scanner.CheckAsync(host, ep.Port, timeoutMs: 1500);

                var idx = Results.FindIndex(r => r.Port == ep.Port);
                if (idx >= 0)
                    Results[idx] = PortRow.FromResults(ep.ServiceName, ep.Port, ep.Modes, ping, portResult);

                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsRunning = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string GetRowDetails(PortRow r)
    {
        if (!r.Checked) return "Not checked";
        if (!string.IsNullOrWhiteSpace(r.Error)) return r.Error!;
        if (r.ConnectTimeMs is not null) return $"Connect: {r.ConnectTimeMs} ms";
        return "-";
    }

    private RenderFragment RenderStatusBadge(bool? ok) => builder =>
    {
        var (text, css) = ok switch
        {
            null  => ("Not checked", "bg-light text-dark border"),
            true  => ("OK", "bg-success"),
            false => ("FAIL", "bg-danger")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", $"badge {css}");
        builder.AddContent(2, text);
        builder.CloseElement();
    };

    private RenderFragment RenderPortBadge(PortRow row) => builder =>
    {
        var (text, css) = row.Checked switch
        {
            false => ("Not checked", "bg-light text-dark border"),
            true when row.PortStatus == PortStatus.Open => ("OPEN", "bg-success"),
            _ => ("CLOSED", "bg-danger")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", $"badge {css}");
        builder.AddContent(2, text);
        builder.CloseElement();
    };

    private string GetModeBadgeClass() => AppArgs.Mode switch
    {
        AppMode.Client => "bg-primary",
        AppMode.Server => "bg-warning text-dark",
        AppMode.Admin  => "bg-danger",
        _              => "bg-secondary"
    };

    private sealed record PortRow(
        string Name,
        int Port,
        string Modes,
        bool Checked,
        bool? PingOk,
        long? PingMs,
        PortStatus? PortStatus,
        long? ConnectTimeMs,
        string? Error)
    {
        public string Key => MakeKey(Port);

        public static string MakeKey(int port) => port.ToString();

        public static int ParseKey(string key) => int.Parse(key);

        public static PortRow NotChecked(string name, int port, string modes)
            => new(name, port, modes, false, null, null, null, null, null);

        public static PortRow FromResults(string name, int port, string modes, PingResult ping, PortResult pr)
            => new(name, port, modes, true, ping.Ok, ping.RoundtripTime, pr.Status, pr.ConnectTimeMs, pr.Error);
    }
}
